var hlib=function(t){var e={};function n(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:r})},n.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";function r(t){return new Promise(function(e,n){var r=new XMLHttpRequest;r.open(t.method,t.url),r.onload=function(){this.status>=200&&this.status<300?e({response:r.response,status:r.status,headers:B(r.getAllResponseHeaders())}):(console.log("http",t.url,this.status),n({status:this.status,statusText:r.statusText}))},r.onerror=function(e){console.log("httpRequest",t.url,this.status),n({error:e,status:this.status,statusText:r.statusText})},t.headers&&Object.keys(t.headers).forEach(function(e){r.setRequestHeader(e,t.headers[e])});var o=t.params;if(o&&"object"==typeof o){const t=Object.keys(o).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])}).join("&")}r.send(o)})}function o(t,e,n){!function t(e,n,o,a,u,i){var s=2e3;e.max&&(s=e.max);var c=200;s<=c&&(c=s),i&&(l(i).innerHTML+=".");var d={method:"get",url:`https://hypothes.is/api/search?_separate_replies=true&limit=${c}&offset=${o}`};["group","user","tag","url","any"].forEach(function(t){if(e[t]){var n=encodeURIComponent(e[t]);d.url+=`&${t}=${n}`}}),r(d=f(d)).then(function(r){r=JSON.parse(r.response),a=a.concat(r.rows),u=u.concat(r.replies),0===r.rows.length||a.length>=s?n(a,u):t(e,n,o+c,a,u,i)})}(t,e,0,[],[],n)}function a(t,e){return e.filter(function(e){return-1!=e.references.indexOf(t)}).map(t=>i(t)).reverse()}function u(t){for(var e={},n={},r={},o={},a={},u=0;u<t.length;u++){var s=i(t[u]),c=s.id;a[c]=s;var l=s.url;l=l.replace(/\/$/,"");var d=s.updated,p=s.title;p||(p=l),l in e?(e[l]+=1,n[l].push(c),d>o.url&&(o[l]=d)):(e[l]=1,n[l]=[c],r[l]=p,o[l]=d)}return{ids:n,urlUpdates:o,annos:a,titles:r,urls:e}}function i(t){var e=t.id,n=t.uri,r=t.updated.slice(0,19),o=t.group,a=n,u=t.references?t.references:[],i=t.user.replace("acct:","").replace("@hypothes.is",""),s="";if(t.target&&t.target.length){var c=t.target[0].selector;if(c)for(var l=0;l<c.length;l++){let t=c[l];"TextQuoteSelector"===t.type&&(s=t.exact)}}var d=t.text?t.text:"",p=t.tags;try{a="object"==typeof(a=t.document.title)?a[0]:n}catch(t){a=n}return{id:e,url:n,updated:r,title:a,refs:u,isReply:u.length>0,isPagenote:t.target&&!t.target[0].hasOwnProperty("selector"),user:i,text:d,quote:s,tags:p,group:o,target:t.target}}function s(t){var e={},n=t[0];if(n){var r=n.selector;if(r){var o=r.filter(t=>"TextQuoteSelector"===t.type);o.length&&(e.TextQuote={exact:o[0].exact,prefix:o[0].prefix,suffix:o[0].suffix});var a=r.filter(t=>"TextPositionSelector"===t.type);a.length&&(e.TextPosition={start:a[0].start,end:a[0].end})}}return e}function c(t,e){e=e?"?"+e:window.location.href,t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(e);return null==n?"":n[1]}function l(t){return document.getElementById(t)}function d(t){document.body.appendChild(t)}function p(t){var e=document.createElement("a");return e.href=t,e.hostname}function f(t,e){return e||(e=g()),e&&(t.headers={Authorization:"Bearer "+e,"Content-Type":"application/json;charset=utf-8"}),t}function g(){return S("h_token")}function h(){return S("h_user")}function v(){var t=S("h_group");return""!=t?t:"__world__"}function m(){$("tokenForm","h_token")}function y(){$("userForm","h_user")}function x(){$("groupForm","h_group")}function $(t,e){var n=l(t).value;localStorage.setItem(e,n)}function S(t,e){var n=c(t);return""===n&&(n=localStorage.getItem(`${t}`)),n&&""!==n||!e||(n=e),n||(n=""),n}function T(t,e){return{read:["group:"+e],update:["acct:"+t+"@hypothes.is"],delete:["acct:"+t+"@hypothes.is"]}}function _(t,e,n){var r={type:"TextQuoteSelector",exact:t};return e&&(r.prefix=e),n&&(r.suffix=n),r}function b(t,e){return{type:"TextPositionSelector",start:t,end:e}}function w(t){var e,n;t.exact&&(e=_(t.exact,t.prefix,t.suffix)),t.start&&t.end&&(n=b(t.start,t.end));var r={source:t.uri};if(e){var o=[e];n&&o.push(n),r.selector=o}var a={uri:t.uri,group:t.group,permissions:T(t.username,t.group),text:t.text,document:{title:[t.uri]},tags:t.tags?t.tags:[]};return r&&(a.target=[r]),t.extra&&(a.extra=t.extra),JSON.stringify(a)}function A(t,e){var n={method:"post",params:t,url:"https://hypothes.is/api/annotations"};return r(n=f(n,e))}function k(t,e,n){return A(t,e).then(t=>{var e=JSON.parse(t.response);if(200==t.status){var r=e.uri;n&&(r+="#"+n),location.href=r}else alert(`hlib status ${t.status}`)}).catch(t=>{console.log(t)})}function F(t,e,n){var o={method:"put",params:n,url:`https://hypothes.is/api/annotations/${t}`};return r(o=f(o,e))}function C(t,e){var n={method:"delete",url:`https://hypothes.is/api/annotations/${t}`};return r(n=f(n,e))}function H(t){P({element:t,name:"Hypothesis API token",id:"token",value:g(),onChange:"setToken",type:"password",msg:'to write (or read protected) annotations, copy/paste your <a href="https://hypothes.is/profile/developer">token</a>'})}function L(t){P({element:t,name:"Hypothesis username",id:"user",value:h(),onChange:"setUser",type:"",msg:""})}function R(t,e,n){var r=`\n    <div class="formLabel">${e}</div>\n    <div class="${e}Form"><input id="${e}Form"></input></div>\n    <div class="formMessage">${n}</div>`;t.innerHTML+=r}function q(){var t=I();localStorage.setItem("h_group",t)}function I(){var t,e=document.querySelector("#groupsList");g()&&e?t=e[e.selectedIndex].value:t="";return t}function O(t){var e=g(),n={method:"get",url:"https://hypothes.is/api/profile"};r(n=f(n,e)).then(n=>{var r=JSON.parse(n.response),o="";e||(o="add token and refresh to see all groups here");var a=`\n        <div class="formLabel">Hypothesis Group</div>\n        <div class="inputForm">${function(t){var e=v(),n="";return t.forEach(t=>{var r="";e==t.id&&(r="selected"),n+=`<option ${r} value="${t.id}">${t.name}</option>\n`}),`\n      <select onchange="hlib.setSelectedGroup()" id="groupsList">\n      ${n}\n      </select>`}(r.groups)}</div>\n        <div class="formMessage">${o}</div>`;t.innerHTML+=a}).catch(t=>{console.log(t)})}function P(t){let{element:e,name:n,id:r,value:o,onChange:a,type:u,msg:i}=t,s=`\n    <div class="formLabel">${n}</div>\n    <div class="${r}Form"><input onchange="${a}()" value="${o}" type="${u}" id="${r}Form"></input></div>\n    <div class="formMessage">${i}</div>`;return e.innerHTML+=s,e}function j(t){var e=[];return t.forEach(function(t){var n=`<a target="_tag" href="./?tag=${t}"><span class="annotationTag">${t}</span></a>`;e.push(n)}),e.join(" ")}function U(t,e){var n=[t.toString(),e.updated,e.url,e.user,e.id,e.group,e.tags.join(", "),e.quote,e.text];return n.push(`https://hyp.is/${e.id}`),(n=n.map(function(t){return t&&(t=`"${t=(t=(t=(t=(t=t.replace(/&/g,"&amp;")).replace(/</g,"&lt;")).replace(/\s+/g," ")).replace(/"/g,'""')).replace(/\r?\n|\r/g," ")}"`),t})).join(",")}function M(t,e){var n=new Date(t.updated),r=n.toLocaleDateString()+" "+n.toLocaleTimeString().replace(/:\d{2}\s/," "),o=null==t.text?"":t.text;o=(new Showdown.converter).makeHtml(o);var a="";t.tags.length&&(a=j(t.tags));var u=t.user.replace("acct:","").replace("@hypothes.is",""),i=t.quote;t.quote&&(i=`<div class="annotationQuote">${t.quote}</div>`);var s=`https://hypothes.is/a/${t.id}`,c=20*e,l="in Public";return"__world__"!==t.group&&(l=`\n      in group\n      <span class="groupid"><a title="search group" target="_group" href="./?group=${t.group}">${t.group}</a>\n      </span>`),`\n    <div class="annotationCard" style="display:block; margin-left:${c}px;">\n      <div class="csvRow">${U(e,t)}</div>\n      <div class="annotationHeader">\n        <span class="user">\n        <a title="search user" target="_user"  href="./?user=${u}">${u}</a>\n        </span>\n      <span class="timestamp"><a title="view/edit/reply"  target="_standalone"\n        href="${s}">${r}</a>\n      </span>\n      ${l}\n      </div>\n      <div class="annotationBody">\n        ${i}\n        <div>${o}</div>\n        <div class="annotationTags">${a}</div>\n      </div>\n    </div>`}function E(t,e){var n=new Blob([t],{type:"application/octet-stream"}),r=URL.createObjectURL(n),o=document.createElement("a");o.href=r,o.target="_blank",o.download="hypothesis."+e,document.body.appendChild(o),o.click()}function B(t){var e={};if(!t)return e;for(var n=t.split("\r\n"),r=0;r<n.length;r++){var o=n[r],a=o.indexOf(": ");if(a>0){var u=o.substring(0,a),i=o.substring(a+2);e[u]=i}}return e}function G(){document.querySelectorAll(".urlHeading .toggle").forEach(function(t){N(t)}),z(document.querySelectorAll(".annotationCard"))}function Q(){document.querySelectorAll(".urlHeading .toggle").forEach(function(t){J(t)}),D(document.querySelectorAll(".annotationCard"))}function N(t){t.innerHTML="▶",t.title="expand"}function J(t){t.innerHTML="▼",t.title="collapse"}function D(t){for(var e=0;e<t.length;e++)t[e].style.display="block"}function z(t){for(var e=0;e<t.length;e++)t[e].style.display="none"}function X(t){var e=l("heading_"+t).querySelector(".toggle"),n=`#${`cards_${t}`} .annotationCard`,r=document.querySelectorAll(n);"block"===r[0].style.display?(N(e),z(r)):(J(e),D(r))}n.r(e),n.d(e,"httpRequest",function(){return r}),n.d(e,"hApiSearch",function(){return o}),n.d(e,"findRepliesForId",function(){return a}),n.d(e,"gatherAnnotationsByUrl",function(){return u}),n.d(e,"parseAnnotation",function(){return i}),n.d(e,"parseSelectors",function(){return s}),n.d(e,"gup",function(){return c}),n.d(e,"getById",function(){return l}),n.d(e,"appendBody",function(){return d}),n.d(e,"getDomainFromUrl",function(){return p}),n.d(e,"setApiTokenHeaders",function(){return f}),n.d(e,"getToken",function(){return g}),n.d(e,"getUser",function(){return h}),n.d(e,"getGroup",function(){return v}),n.d(e,"setToken",function(){return m}),n.d(e,"setUser",function(){return y}),n.d(e,"setGroup",function(){return x}),n.d(e,"setLocalStorageFromForm",function(){return $}),n.d(e,"getFromUrlParamOrLocalStorage",function(){return S}),n.d(e,"createPermissions",function(){return T}),n.d(e,"createTextQuoteSelector",function(){return _}),n.d(e,"createTextPositionSelector",function(){return b}),n.d(e,"createAnnotationPayload",function(){return w}),n.d(e,"postAnnotation",function(){return A}),n.d(e,"postAnnotationAndRedirect",function(){return k}),n.d(e,"updateAnnotation",function(){return F}),n.d(e,"deleteAnnotation",function(){return C}),n.d(e,"createApiTokenInputForm",function(){return H}),n.d(e,"createUserInputForm",function(){return L}),n.d(e,"createFacetInputForm",function(){return R}),n.d(e,"setSelectedGroup",function(){return q}),n.d(e,"getSelectedGroup",function(){return I}),n.d(e,"createGroupInputForm",function(){return O}),n.d(e,"createNamedInputForm",function(){return P}),n.d(e,"formatTags",function(){return j}),n.d(e,"csvRow",function(){return U}),n.d(e,"showAnnotation",function(){return M}),n.d(e,"download",function(){return E}),n.d(e,"parseResponseHeaders",function(){return B}),n.d(e,"collapseAll",function(){return G}),n.d(e,"expandAll",function(){return Q}),n.d(e,"setToggleControlCollapse",function(){return N}),n.d(e,"setToggleControlExpand",function(){return J}),n.d(e,"showCards",function(){return D}),n.d(e,"hideCards",function(){return z}),n.d(e,"toggle",function(){return X})}]);