var hlib=function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t),n.d(t,"getSettings",function(){return o}),n.d(t,"updateSettings",function(){return a}),n.d(t,"httpRequest",function(){return i}),n.d(t,"hApiSearch",function(){return u}),n.d(t,"search",function(){return s}),n.d(t,"findRepliesForId",function(){return c}),n.d(t,"showThread",function(){return l}),n.d(t,"gatherAnnotationsByUrl",function(){return d}),n.d(t,"parseAnnotation",function(){return p}),n.d(t,"parseSelectors",function(){return f}),n.d(t,"gup",function(){return g}),n.d(t,"getById",function(){return h}),n.d(t,"appendBody",function(){return v}),n.d(t,"getDomainFromUrl",function(){return m}),n.d(t,"setApiTokenHeaders",function(){return $}),n.d(t,"getToken",function(){return y}),n.d(t,"getUser",function(){return x}),n.d(t,"getGroup",function(){return _}),n.d(t,"setToken",function(){return w}),n.d(t,"setUser",function(){return S}),n.d(t,"setGroup",function(){return T}),n.d(t,"setLocalStorageFromForm",function(){return b}),n.d(t,"getFromUrlParamOrLocalStorage",function(){return A}),n.d(t,"createPermissions",function(){return L}),n.d(t,"createTextQuoteSelector",function(){return k}),n.d(t,"createTextPositionSelector",function(){return F}),n.d(t,"createAnnotationPayload",function(){return H}),n.d(t,"postAnnotation",function(){return P}),n.d(t,"postAnnotationAndRedirect",function(){return C}),n.d(t,"updateAnnotation",function(){return O}),n.d(t,"deleteAnnotation",function(){return I}),n.d(t,"createApiTokenInputForm",function(){return q}),n.d(t,"createUserInputForm",function(){return M}),n.d(t,"createNamedInputForm",function(){return R}),n.d(t,"createFacetInputForm",function(){return j}),n.d(t,"setSelectedGroup",function(){return E}),n.d(t,"getSelectedGroup",function(){return U}),n.d(t,"createGroupInputForm",function(){return B}),n.d(t,"formatTags",function(){return G}),n.d(t,"csvRow",function(){return N}),n.d(t,"showAnnotation",function(){return Q}),n.d(t,"download",function(){return J}),n.d(t,"parseResponseHeaders",function(){return D}),n.d(t,"collapseAll",function(){return z}),n.d(t,"expandAll",function(){return K}),n.d(t,"setToggleControlCollapse",function(){return V}),n.d(t,"setToggleControlExpand",function(){return W}),n.d(t,"showCards",function(){return X}),n.d(t,"hideCards",function(){return Y}),n.d(t,"toggle",function(){return Z});var r={service:"https://hypothes.is"};function o(){return r}function a(e){r=Object.assign(e)}function i(e){return new Promise((t,n)=>{let r=new Request(e.url),o={method:e.method,headers:e.headers},a=e.method.toLowerCase();"get"!==a&&"head"!==a&&(o.body=e.params),fetch(r,o).then(e=>e.text()).then(e=>{t({response:e})}).catch(t=>{console.error("rejected",e,t),n(t)})})}function u(e,t,n){!function e(t,n,o,a,u,s){let c=2e3;t.max&&(c=t.max);let l=200;c<=l&&(l=c),s&&(h(s).innerHTML+=".");let d=n?`&search_after=${n}`:"",p={method:"get",url:`${r.service}/api/search?_separate_replies=true&limit=${l}${d}`,headers:{},params:{}};["group","user","tag","url","wildcard_uri","any"].forEach(function(e){if(t[e]){var n=encodeURIComponent(t[e]);p.url+=`&${e}=${n}`}}),i(p=$(p)).then(function(n){let r=JSON.parse(n.response);if(a=a.concat(r.rows),u=u.concat(r.replies),0===r.rows.length||a.length>=c)o(a,u);else{let n=r.rows.slice(-1)[0].updated;e(t,n,o,a,u,s)}})}(e,"",t,[],[],n)}function s(e,t){return new Promise(n=>{n(function e(t,n,o,a,u){return new Promise((s,c)=>{let l=2e3;t.max&&(l=t.max);let d=200;l<=d&&(d=l),u&&(h(u).innerHTML+=".");let p="true"===t._separate_replies?"&_separate_replies=true":"",f=n?`&search_after=${n}`:"",g={method:"get",url:`${r.service}/api/search?limit=${d}${p}${f}`,headers:{},params:{}};console.log(g),["group","user","tag","url","wildcard_uri","any"].forEach(function(e){if(t[e]){var n=encodeURIComponent(t[e]);g.url+=`&${e}=${n}`}}),i(g=$(g)).then(function(n){let r=JSON.parse(n.response);if(o=o.concat(r.rows),r.replies&&(a=a.concat(r.replies)),0===r.rows.length||o.length>=l){let e=[o,a];console.log("hlib http response",e),s(e)}else{let n=r.rows.slice(-1)[0].updated;s(e(t,n,o,a,u))}}).catch(e=>{c(e)})})}(e,"",[],[],t))})}function c(e,t){return t.filter(t=>-1!=t.references.indexOf(e))}function l(e,t,n,r,o){if(-1==r.indexOf(e.id)){r.push(e.id);let a=c(e.id,n),i=p(e);o.innerHTML+=Q(i,t),a.forEach(e=>{l(e,t+1,a,r,o)})}}function d(e){for(var t={},n={},r={},o={},a={},i=0;i<e.length;i++){var u=p(e[i]),s=u.id;a[s]=u;var c=u.url;c=c.replace(/\/$/,"");var l=u.updated,d=u.title;d||(d=c),c in t?(t[c]+=1,n[c].push(s),l>o.url&&(o[c]=l)):(t[c]=1,n[c]=[s],r[c]=d,o[c]=l)}return{ids:n,urlUpdates:o,annos:a,titles:r,urls:t}}function p(e){var t=e.id,n=e.uri,r=e.updated.slice(0,19),o=e.group,a=n,i=e.references?e.references:[],u=e.user.replace("acct:","").replace("@hypothes.is",""),s="";if(e.target&&e.target.length){var c=e.target[0].selector;if(c)for(var l=0;l<c.length;l++){let e=c[l];"TextQuoteSelector"===e.type&&(s=e.exact)}}var d=e.text?e.text:"",p=e.tags;try{a="object"==typeof(a=e.document.title)?a[0]:n}catch(e){a=n}return{id:t,url:n,updated:r,title:a,refs:i,isReply:i.length>0,isPagenote:e.target&&!e.target[0].hasOwnProperty("selector"),user:u,text:d,quote:s,tags:p,group:o,target:e.target}}function f(e){var t={},n=e[0];if(n){var r=n.selector;if(r){var o=r.filter(function(e){return"TextQuoteSelector"===e.type});o.length&&(t.TextQuote={exact:o[0].exact,prefix:o[0].prefix,suffix:o[0].suffix});var a=r.filter(function(e){return"TextPositionSelector"===e.type});a.length&&(t.TextPosition={start:a[0].start,end:a[0].end})}}return t}function g(e,t){t=t?"?"+t:window.location.href,e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(t);return null==n?"":n[1]}function h(e){return document.getElementById(e)}function v(e){document.body.appendChild(e)}function m(e){var t=document.createElement("a");return t.href=e,t.hostname}function $(e,t){return t||(t=y()),t&&(e.headers={Authorization:"Bearer "+t,"Content-Type":"application/json;charset=utf-8"}),e}function y(){return A("h_token")}function x(){return A("h_user")}function _(){var e=A("h_group");return""!=e?e:"__world__"}function w(){b("tokenForm","h_token")}function S(){b("userForm","h_user")}function T(){b("groupForm","h_group")}function b(e,t){var n=h(e);localStorage.setItem(t,n.value)}function A(e,t){var n=g(e);if(""===n){let t=localStorage.getItem(`${e}`);n=t||""}return n&&""!==n||!t||(n=t),n||(n=""),n}function L(e,t){return{read:["group:"+t],update:["acct:"+e+"@hypothes.is"],delete:["acct:"+e+"@hypothes.is"]}}function k(e,t,n){let r={type:"TextQuoteSelector",exact:e,prefix:"",suffix:""};return t&&(r.prefix=t),n&&(r.suffix=n),r}function F(e,t){return{type:"TextPositionSelector",start:e,end:t}}function H(e){let t,n;e.exact&&(t=k(e.exact,e.prefix,e.suffix)),e.start&&e.end&&(n=F(e.start,e.end));var r={source:e.uri};if(t){var o=[t];n&&o.push(n),r.selector=o}var a={uri:e.uri,group:e.group,permissions:L(e.username,e.group),text:e.text,document:{title:[e.uri]},tags:e.tags?e.tags:[]};return r&&(a.target=[r]),e.extra&&(a.extra=e.extra),JSON.stringify(a)}function P(e,t){var n={method:"post",params:e,url:`${r.service}/api/annotations`,headers:{}};return i(n=$(n,t))}function C(e,t,n){return P(e,t).then(e=>{let t=e,r=t.status;if(200==r){var o=JSON.parse(t.response).uri;n&&(o+="#"+n),location.href=o}else alert(`hlib status ${r}`)}).catch(e=>{console.log(e)})}function O(e,t,n){var o={method:"put",params:n,url:`${r.service}/api/annotations/${e}`,headers:{}};return i(o=$(o,t))}function I(e,t){var n={method:"delete",url:`${r.service}/api/annotations/${e}`,headers:{},params:{}};return i(n=$(n,t))}function q(e){R({element:e,name:"Hypothesis API token",id:"token",value:y(),onchange:"hlib.setToken",type:"password",msg:`to write (or read private) annotations, copy/paste your <a target="_token" href="${r.service}/profile/developer">token</a>`})}function M(e,t){R({element:e,name:"Hypothesis username",id:"user",value:x(),onchange:"hlib.setUser",type:"",msg:t||""})}function R(e){let{element:t,name:n,id:r,value:o,onchange:a,type:i,msg:u}=e,s=`\n    <div class="formLabel">${n}</div>\n    <div class="${r}Form"><input onchange="${a}()" value="${o}" type="${i}" id="${r}Form"></input></div>\n    <div class="formMessage">${u}</div>`;return t.innerHTML+=s,t}function j(e,t,n,r){r||(r="");var o=`\n    <div class="formLabel">${t}</div>\n    <div class="${t}Form"><input value="${r}" id="${t}Form"></input></div>\n    <div class="formMessage">${n}</div>`;return e.innerHTML+=o,e}function E(){var e=U();localStorage.setItem("h_group",e)}function U(e){let t=e||"groupsList";t="#"+t;let n=document.querySelector(t).options;return n[n.selectedIndex].value}function B(e,t){let n=t||"groupsList";var o=y(),a={method:"get",url:`${r.service}/api/profile`,headers:{},params:{}};i(a=$(a,o)).then(t=>{let r=JSON.parse(t.response);var a="";o||(a='add token and <a href="javascript:location.href=location.href">refresh</a> to see all groups here');var i=`\n        <div class="formLabel">Hypothesis Group</div>\n        <div class="inputForm">${function(e,t){var r=_(),o="";return e.forEach(function(e){var t="";r==e.id&&(t="selected"),o+=`<option ${t} value="${e.id}">${e.name}</option>\n`}),`\n      <select onchange="hlib.setSelectedGroup()" id="${n}">\n      ${o}\n      </select>`}(r.groups)}</div>\n        <div class="formMessage">${a}</div>`;e.innerHTML+=i}).catch(e=>{console.error(e)})}function G(e,t){var n=[];return e.forEach(function(e){var r=`<a target="_tag" href="${t?t+e:`./?tag=${e}`}"><span class="annotationTag">${e}</span></a>`;n.push(r)}),n.join(" ")}function N(e,t){var n=[e.toString(),t.updated,t.url,t.user,t.id,t.group,t.tags.join(", "),t.quote,t.text];return n.push(`https://hyp.is/${t.id}`),(n=n.map(function(e){return e&&(e=`"${e=(e=(e=(e=(e=e.replace(/&/g,"&amp;")).replace(/</g,"&lt;")).replace(/\s+/g," ")).replace(/"/g,'""')).replace(/\r?\n|\r/g," ")}"`),e})).join(",")}function Q(e,t,n){var o=new Date(e.updated),a=o.toLocaleDateString()+" "+o.toLocaleTimeString().replace(/:\d{2}\s/," "),i=null==e.text?"":e.text;i=(new Showdown.converter).makeHtml(i);var u="";e.tags.length&&(u=G(e.tags,n));var s=e.user.replace("acct:","").replace("@hypothes.is",""),c=e.quote;e.quote&&(c=`<div class="annotationQuote">${e.quote}</div>`);var l=`${r.service}/a/${e.id}`,d=20*t,p="in Public";return"__world__"!==e.group&&(p=`\n      in group\n      <span class="groupid"><a title="search group" target="_group" href="./?group=${e.group}">${e.group}</a>\n      </span>`),`\n    <div class="annotationCard" style="display:block; margin-left:${d}px;">\n      <div class="csvRow">${N(t,e)}</div>\n      <div class="annotationHeader">\n        <span class="user">\n        <a title="search user" target="_user"  href="./?user=${s}">${s}</a>\n        </span>\n      <span class="timestamp"><a title="view/edit/reply"  target="_standalone"\n        href="${l}">${a}</a>\n      </span>\n      ${p}\n      </div>\n      <div class="annotationBody">\n        ${c}\n        <div>${i}</div>\n        <div class="annotationTags">${u}</div>\n      </div>\n      <hr class="annotationCardDivider">\n    </div>`}function J(e,t){var n=new Blob([e],{type:"application/octet-stream"}),r=URL.createObjectURL(n),o=document.createElement("a");o.href=r,o.target="_blank",o.download="hypothesis."+t,document.body.appendChild(o),o.click()}function D(e){var t={};if(!e)return t;for(var n=e.split("\r\n"),r=0;r<n.length;r++){var o=n[r],a=o.indexOf(": ");if(a>0){var i=o.substring(0,a),u=o.substring(a+2);t[i]=u}}return t}function z(){document.querySelectorAll(".urlHeading .toggle").forEach(function(e){V(e)}),Y(document.querySelectorAll(".annotationCard"))}function K(){document.querySelectorAll(".urlHeading .toggle").forEach(e=>{W(e)}),X(document.querySelectorAll(".annotationCard"))}function V(e){e.innerHTML="▶",e.title="expand"}function W(e){e.innerHTML="▼",e.title="collapse"}function X(e){for(var t=0;t<e.length;t++)e[t].style.display="block"}function Y(e){for(var t=0;t<e.length;t++)e[t].style.display="none"}function Z(e){var t=h("heading_"+e).querySelector(".toggle"),n=`#${`cards_${e}`} .annotationCard`,r=document.querySelectorAll(n);"block"===r[0].style.display?(V(t),Y(r)):(W(t),X(r))}}]);
//# sourceMappingURL=hlib.bundle.js.map