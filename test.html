<html>
<head>
<script src="tinytest.js"></script>
</head>

<body>

<div style="display:none"><input id="token"/></div>

<!-- this duplicates hlib.setUser because forms created in tests can't see the module -->
<script>
  function setUser() {
    var value = document.getElementById('userForm').value;
    localStorage.setItem('h_user', value); 
}
</script>

<script type="module">

import * as hlib from 'http://localhost:8000/hlib.js'

var scratchUri = 'https://jonudell.net/h/scratch.html'
var scratchQuote = 'First para'
var scratchText = 'hlib test'

function delay(seconds) {
  return new Promise( resolve => setTimeout(resolve, seconds * 1000))
}

async function waitSeconds(seconds, data) {
  await delay(seconds)
  return data
  }

function appendBody(element) {
  document.body.appendChild(element)
}

function createGroupContainer() {
  var groupContainer = document.createElement('div');
  groupContainer.id = 'groupContainer';
  document.body.append(groupContainer);
  return groupContainer;
}

function removeGroupContainer() {
  var groupContainer = hlib.getById('groupContainer')
  if (groupContainer) {
    groupContainer.remove()
  }
}

function checkAndDeleteTestAnnotation(data, token) {
  try {	
    var response = JSON.parse(data.response)
    if (response.target[0].selector) {
      var selectors = hlib.parseSelectors(response.target)
      eq(selectors.TextQuote.exact, scratchQuote)
      var annotation = hlib.parseAnnotation(response)
      eq(annotation.quote, scratchQuote)
    }
    assert(response.id)
    assert(response.updated)
    hlib.deleteAnnotation(response.id, token)
     .then(data => {
        console.log('deleted test annotation', data)
     })
  } catch(e) {
	console.error(e)
	failHard()
  }
}

tests({ 

'gets token': function() {
   let token = hlib.getToken()
   let slice = token.slice(0,9)
   eq(slice, '6879-358c')
 },

'gets "" when no user': function() {
   delete localStorage['h_user']
   let user = hlib.getUser()
   eq(user, "")
  },

'username input form saves and retrieves value': function() {
   let formElement = document.createElement('div')
   let args = {
     element: formElement,
     name: 'Hypothesis username',
     id: 'user',
     value: '',
     onchange: 'setUser',
     type: '',
     msg: ''
   }
   let form = hlib.createNamedInputForm(args)
   appendBody(form)
   let inputElement = hlib.getById('userForm')
   inputElement.value = 'judell'
   let evt = document.createEvent("HTMLEvents")
   evt.initEvent("change", false, true)
   inputElement.dispatchEvent(evt)
   eq(hlib.getUser(), 'judell')
   delete localStorage['h_user']
   form.remove()
 }, 
 
'creates group picklist with > 1 groups when token': function() {
   var groupContainer = createGroupContainer()
   hlib.createGroupInputForm(groupContainer)
   waitSeconds(1)
     .then( r => {
       let groupList = hlib.getById('groupsList')
       assert(groupList)
       let options = groupList.querySelectorAll('option')
       assert(groupList.length > 1)
     })
     .catch (e => {
       console.error(e)
       failHard()
     })
     .finally(removeGroupContainer)
 },

'creates group picklist with 1 group when no token': function() {
  var token = hlib.getToken()
  hlib.getById('token').setAttribute('value',token)
  delete localStorage['h_token']
  var groupContainer = createGroupContainer()
  hlib.createGroupInputForm(groupContainer)
  waitSeconds(1)
    .then( r => {
      localStorage['h_token'] = hlib.getById('token').value  // not in effect for subsequent tests
      let groupList = hlib.getById('groupsList')
      assert(groupList)
      let options = groupList.querySelectorAll('option')
      assert(groupList.length == 1, `expected 1, got ${groupList.length}`)
     })
     .catch (e => {
       console.log(e)
       failHard()
     })
     .finally(removeGroupContainer)
 },

 'creates a pagenote': function() {
   var token = hlib.getById('token').value
   var params = {}
   params.uri = scratchUri,
   params.group = '__world__'
   params.text = scratchText
   var payload = hlib.createAnnotationPayload(params)
   hlib.postAnnotation(payload, token)
     .then(data => {
       waitSeconds(1, data)
         .then(data => {
           checkAndDeleteTestAnnotation(data, token)
          })
       })
 },

 'creates an annotation': function() {
   var token = hlib.getById('token').value
   var params = {}
   params.uri = scratchUri,
   params.group = '__world__'
   params.text = scratchText
   params.exact = scratchQuote
   var payload = hlib.createAnnotationPayload(params)
   hlib.postAnnotation(payload, token)
     .then(data => {
       waitSeconds(1, data)
       .then(data => {
         checkAndDeleteTestAnnotation(data, token)
       })
     })
 }

})
</script>

</body>
</html>