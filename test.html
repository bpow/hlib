<html>
<head>
<script src="tinytest.js"></script>
<script src="hlib.js"></script> 
</head>

<body>

<div style="display:none"><input id="token"/></div>

<script>

var scratchUri = 'https://jonudell.net/h/scratch.html';

function delay(seconds) {
  return new Promise( resolve => setTimeout(resolve, seconds * 1000));
}

async function waitSeconds(seconds, data) {
  await delay(seconds);
  return data;
  }

function appendBody(element) {
  document.body.appendChild(element);
}

function createGroupContainer() {
  var groupContainer = document.createElement('div');
  groupContainer.id = 'groupContainer';
  document.body.append(groupContainer);
  return groupContainer;
}

function removeGroupContainer() {
  var groupContainer = getById('groupContainer');
  if (groupContainer) {
    groupContainer.remove();
  }
}

function checkAndDeleteTestAnnotation(data, token) {
  try {	
    var response = JSON.parse(data.response);
    assert(response.id);
    assert(response.updated);
    deleteAnnotation(response.id, token)
     .then(data => {
        console.log('deleted test annotation', data);
     });
  } catch(e) {
	console.error(e);  
	failHard();
  }
}


tests({ 

'gets token': function() {
   let token = getToken();
   let slice = token.slice(0,9);
   eq(slice, '6879-358c');
 },

'gets "" when no user': function() {
   delete localStorage['h_user'];
   let user = getUser();
   eq(user, "");
 },

'username input form saves and retrieves value': function() {
   let formElement = document.createElement('div');
   let args = {
     element: formElement,
     name: 'Hypothesis username',
     id: 'user',
     value: '',
     onChange: 'setUser',
     type: '',
     msg: ''
   };
   let form = createNamedInputForm(args);
   appendBody(form);
   let inputElement = getById('userForm');
   inputElement.value = 'judell';
   let evt = document.createEvent("HTMLEvents");
   evt.initEvent("change", false, true);
   inputElement.dispatchEvent(evt);
   eq(getUser(), 'judell');
   delete localStorage['h_user'];
   form.remove();
 },

'creates group picklist with > 1 groups when token': function() {
   var groupContainer = createGroupContainer();
   createGroupInputForm(groupContainer);
   waitSeconds(1)
     .then( r => {
       let groupList = getById('groupsList');
       assert(groupList);
       let options = groupList.querySelectorAll('option');
       assert(groupList.length > 1);
     })
     .catch (e => {
       console.error(e);
       failHard();
     })
     .finally(removeGroupContainer);
 },

'creates group picklist with 1 group when no token': function() {
  var token = getToken();
  getById('token').setAttribute('value',token);
  delete localStorage['h_token'];
  var groupContainer = createGroupContainer();     
  createGroupInputForm(groupContainer);
  waitSeconds(1)
    .then( r => {
      localStorage['h_token'] = getById('token').value;  // not in effect for subsequent tests
      let groupList = getById('groupsList');
      assert(groupList);
      let options = groupList.querySelectorAll('option');
      assert(groupList.length == 1, `expected 1, got ${groupList.length}`);
     })
     .catch (e => {
       console.log(e);
       failHard();
     })
     .finally(removeGroupContainer);
 },

 'creates a pagenote': function() {
   var token = getById('token').value;
   var params = {};
   params.uri = scratchUri,
   params.group = '__world__';
   params.text = 'hlib test';
   var payload = createAnnotationPayload(params);
   postAnnotation(payload, token)
     .then(data => {
       waitSeconds(1, data)
         .then(data => {
           checkAndDeleteTestAnnotation(data, token);
          });
       });
 },

 'creates an annotation': function() {
   var token = getById('token').value;
   var params = {};
   params.uri = scratchUri,
   params.group = '__world__';
   params.text = 'hlib test';
   params.exact = 'First para';
   var payload = createAnnotationPayload(params);
   postAnnotation(payload, token)
     .then(data => {
       waitSeconds(1, data)
       .then(data => {
         checkAndDeleteTestAnnotation(data, token);
       });
     });
 }

});
</script>

</body>
</html>